# Webhooks

## Retry Behavior

When a Webhook receives a status code that is not a 200, we will attempt to retry the request every 15 minutes until 24 hours have passed or a response code of 200 is received.

## Validating the Payload

You can verify the authenticity of a webhook request from friendbuy by analyzing its cryptographic signature. When friendbuy sends a request to your endpoints, a signature is placed in the X-Friendbuy-Hmac-SHA256 header, and is computed by Base64 encoding the HMAC-SHA1 hash of the request body with your friendbuy secret key.

See <a href="#signature-validation">Signature Validation</a> for instructions on validating the signature.

## Reward Webhook

> Example Payload

```json
{
  "id": "255e4e45-446d-499d-a680-44ab1eca73fb",
  "type": "advocateReward",
  "data": [
    {
      "rewardId": "73cb50ea-7ac8-4f90-9fe4-f5450866f3c0",
      "rewardType": "discount",
      "rewardUnit": "USD",
      "emailAddress": "test@example.com",
      "rewardAmount": "20.00",
      "createdOn": "2019-11-05T01:07:36.720Z",
      "customerId": "asd123-abcfasdf",
      "couponCode": "test-coupon-code"
    }
  ],
  "createdOn": "2019-11-05T01:07:38.509Z"
}
```

A reward is created after a conversion is evaluated and determined to be rewardable \(i.e. all business rules and fraud checks have been met and the reward falls into a specific tier\).

The Reward Webhook is the preferred method for depositing credit or points into an Advocateâ€™s account in your system.

After a reward is created, friendbuy will send a POST request to your system with data about the reward.

### Payload

| Property  | type             | Description                                                                                                                           |
| :-------- | :--------------- | :------------------------------------------------------------------------------------------------------------------------------------ |
| id        | string           | The id of the webhook. Useful for troubleshooting.                                                                                    |
| type      | "advocateReward" | Indicates that this is an advocate reward request.                                                                                    |
| createdOn | ISO timestamp    | The date and time the webhook request was made.                                                                                       |
| data      | array of objects | An array of webhook payloads, see definition below. Multiple rewards may fire in the same webhook if they happen in quick succession. |

Reward details will be available in the `data` property of the request with the following format:

| Property     | Type          | Description                                                                                                                                                                                      |
| :----------- | :------------ | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| rewardId     | string        | The id of the reward. Useful for troubleshooting and preventing duplicate reward distributions.                                                                                                  |
| rewardType   | string        | The type of the reward. One of `"discount", "credit", "giftCard", "cash", "product", "other", "ledger", or "integration"`                                                                        |
| rewardUnit   | string        | The unit of the reward applicable to the `rewardType`currency code \(e.g. "USD"\), percent \("%"\), or product SKU                                                                               |
| customerId   | string        | The customer id of the advocate to be rewarded, if provided. Note: this is your customer ID provided to friendbuy through the javascript integration, not an internal ID generated by friendbuy. |
| emailAddress | string        | The email address of the advocate to be rewarded.                                                                                                                                                |
| amount       | number        | The numerical value of the reward. Typically the value of the coupon or the amount of credit to deposit.                                                                                         |
| createdOn    | ISO timestamp | The date and time the reward was created.                                                                                                                                                        |
| couponCode   | string        | The coupon code that was distributed with this reward, if any.                                                                                                                                   |

## Email Capture Webhook

> Example Payload

```json
{
  "id": "255e4e45-446d-499d-a680-44ab1eca73fb",
  "type": "emailCapture",
  "data": [
    {
      "eventId": "e6c720d4-b721-4789-a110-0d680777b802",
      "emailAddress": "john.customer@example.com",
      "name": "John Customer",
      "campaign": {
        "id": "8a7b9436-8b91-4022-b830-d405dfcc3964",
        "name": "Spring Campaign"
      },
      "referral": {
        "channel": "purl",
        "code": "7p9axss2"
      },
      "advocate": {
        "email": "sarah.advocate@example.com",
        "name": "Sarah Advocate"
      },
      "attributionId": "fea9b87a-9411-4a10-aa41-aa137a09849d",
      "incentive": {
        "couponCode": "Test couponCode",
        "amount": 30,
        "currency": "USD"
      }
    }
  ],
  "createdOn": "2019-11-05T01:07:38.509Z"
}
```

An email capture is created when someone enters their email into a friend incentive widget or the email gate of a referral widget and checks the opt-in checkbox.

The email capture webhook can be used to funnel these emails into your system to add them into your mailing list or for internal record keeping amongst other uses.

After an email capture is created, Friendbuy will send a POST request to your system with data about the captured email.

**NOTE: The email capture widget will only fire if someone checks the opt-in checkbox before submitting their email address.**

### Payload

| Property  | Type             | Description                                                                                                                           |
| :-------- | :--------------- | :------------------------------------------------------------------------------------------------------------------------------------ |
| id        | string           | The id of the webhook. Useful for troubleshooting.                                                                                    |
| type      | "emailCapture"   | Indicates that this is an email capture request.                                                                                      |
| createdOn | ISO timestamp    | The date and time the webhook request was made.                                                                                       |
| data      | array of objects | An array of webhook payloads, see definition below. Multiple email captures may be sent in the same webhook call if they happen in quick succession. |

Email Capture details will be available in the `data` property of the request with the following format:

| Property      | Type   | Description                                                          |
| :------------ | :----- | :------------------------------------------------------------------- |
| eventId       | string | The id of the email capture event. Useful for troubleshooting.       |
| emailAddress  | string | The email address entered into the email field.                      |
| name          | string | The name entered into the email capture widget.                      |
| campaign      | object | The campaign details for the campaign the email was captured with.   |
| referral      | object | Details about the referral for a referred friend.                    |
| advocate      | object | Details about the advocate for a referred friend.                    |
| attributionId | string | The id of the attribution that connects the advocate and the friend. |
| incentive     | object | The incentive associated with the email capture, if any.             |

The `campaign` object in the payload has the following structure:

| Property | Type   | Description                                         |
| :------- | :----- | :-------------------------------------------------- |
| id       | string | The id of the campaign used to capture the email.   |
| name     | string | The name of the campaign used to capture the email. |

The `referral` object in the payload has the following structure:

| Property | Type   | Description                                                                                    |
| :------- | :----- | :--------------------------------------------------------------------------------------------- |
| code     | string | The referral code for the referral that resulted in the friends' email address being captured. |
| channel  | string | The referral channel.                                                                          |

The `advocate` object in the payload has the following structure:

| Property | Type   | Description                                                           |
| :------- | :----- | :-------------------------------------------------------------------- |
| email    | string | The email address entered by the advocate when creating the referral. |
| name     | string | The name entered by the advocate when creating the referral.          |
| customerId | string | The advocate's customer id, if known.                               |

The `incentive` object in the payload has the following structure:

| Property   | Type   | Description                                                                |
| :--------- | :----- | :------------------------------------------------------------------------- |
| couponCode | string | The coupon code given to the user for entering their email, if applicable. |
| amount     | number | The numerical value of the incentive.                                      |
| currency   | string | The currency of the incentive \(i.e. "USD"\).                              |

## Email Opt-Out Webhook

> Example Payload

``` json
{
  "id": "fd2f5766-8c27-4bfe-b3d3-9f41e186b13e",
  "type": "emailOptOut",
  "data": [
    {
      "emailAddress": "a.friend@example.com",
      "campaignId": "8a7b9436-8b91-4022-b830-d405dfcc3964",
      "campaignName": "Spring Campaign"
    }
  ],
  "createdOn": "2021-06-01T14:28:27.657Z"
}
```

An email opt-out is created when a friend who receives an advocate share email clicks the unsubscribe link in that email. When this happens, Friendbuy records the opt-out request and will not send any future share emails to that email address for any of your campaigns.

The email opt-out webhook can be used to also notify you when someone opts out of receiving future share emails so that you can add their email address to your own email address opt-out list. If the email opt-out webhook is configured and enabled then, after an email opt-out is created, Friendbuy will send a POST request to your system with data about the opt-out request.

### Payload

| Property  | Type             | Description                                                                                                                                        |
|:----------|:-----------------|:---------------------------------------------------------------------------------------------------------------------------------------------------|
| id        | string           | The id of the webhook call. Useful for troubleshooting.                                                                                            |
| type      | "emailOptOut"    | Indicates that this is an email opt-out request.                                                                                                   |
| createdOn | ISO timestamp    | The date and time the webhook request was made.                                                                                                    |
| data      | array of objects | An array of webhook payloads, see definition below. Multiple opt-outs may be sent in the same webhook call if they happen in quick succession. |

Email Opt-Out details will be available in the `data` property of the request with the following format:

| Property     | Type   | Description                                                    |
|:-------------|:-------|:---------------------------------------------------------------|
| emailAddress | string | The email address of the user who entered into the email field. |
| campaignId   | string | The id of the campaign that the share email was for.           |
| campaignName | string | The name of the campaign that the share email was for.         |

